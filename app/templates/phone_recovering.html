{% extends "base.html" %} {% block head %}
<link rel="stylesheet" href="./static/css/Login.css" />
{% endblock %} {% block Title %}ورود{% endblock %} {% block content %} {% raw %}
<div id="app" dir="rtl" class="Form-box">
    <h4 ref="des" style="line-height: normal" class="des">
        لطفا شماره تلفن خود را وارد کنید
    </h4>
    <div class="inp-box">
        <p v-if="!phone">پس از ورود، می توانید رمز عبور خود را تغییر دهید</p>
        <input
            ref="usernameinput"
            @keydown="key_downed"
            @keydown.enter="enter()"
            dir="ltr"
            :style="style"
            v-model="value"
            style="text-align: center; font-size: 0.9rem"
            :placeholder="placeholder"
            type="text"
            class="username-inp"
        />
        <p v-if="error" class="error">{{ error_text }}</p>
    </div>
    <button @click="code()" v-if="!phone" id="username-sub">ارسال</button>
    <button @click="login()" v-if="phone" id="username-sub">ورود</button>
    <a href="/" class="link">بازگشت به صفحه ورود</a><br />
    <a href="/recovery" class="link">روش های دیگر</a>
</div>

<script>
    new Vue({
        el: "#app",
        data: {
            value: "",
            error_text: "",
            error: "",
            style: "",
            phone: "",
            placeholder: 'شماره تلفن'
        },
        methods: {
            key_downed() {
                // this function is for close errors
                this.error = false;
                this.error_text = "";
                style = "";
            },
            enter() {
                if (this.phone) {
                    this.code();
                } else {
                    this.login();
                }
            },
            code() {
                // this function is for key validation and login
                console.log(
                    (this.value.length != 11) | (this.value.slice(1, 2) != "9")
                );
                if (
                    (this.value.length != 11) |
                    (this.value.slice(1, 2) != "9")
                ) {
                    this.error = true;
                    this.error_text =
                        "لطفا شماره موبایل خود را به درستی وارد کنید (09xxxxxxxxx) ";
                    style = "border: 2px solid red";
                } else {
                    let data = new FormData();
                    data.append("phone", this.value);

                    fetch("/api/recovery/phone", { method: "POST", body: data })
                        .then((response) => {
                            if (response.status == 429) {
                                throw new Error("429");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data.success) {
                                if (data.valid) {
                                    this.$refs.des.innerText =
                                        "لطفا کد تایید ارسال شده را وارد نمایید";
                                    this.phone = this.value;
                                    this.value = "";
                                    this.placeholder = 'کد تایید'
                                } else {
                                    this.error = true;
                                    this.error_text =
                                        "شماره تلفن وارد شده نامعتبر است";
                                    style = "border: 2px solid red";
                                }
                            } else {
                                this.error = true;
                                this.error_text =
                                    "مشکلی پیش آمده، کمی بعد دوباره تلاش کنید";
                                style = "border: 2px solid red";
                            }
                        })
                        .catch((error) => {
                            this.error = true;
                            this.error_text =
                                "مشکلی پیش آمده، کمی بعد دوباره تلاش کنید";
                            style = "border: 2px solid red";
                        });
                }
            },
            login() {
                if (this.value.length != 6) {
                    this.error = true;
                    this.error_text =
                        "لطفا شماره موبایل خود را به درستی وارد کنید (09xxxxxxxxx) ";
                    style = "border: 2px solid red";
                } else {
                    let data = new FormData();
                    data.append("phone", this.phone);
                    data.append("code", this.value);

                    fetch("/api/recovery/phone", { method: "POST", body: data })
                        .then((response) => {
                            if (response.status == 429) {
                                throw new Error("429");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data.success) {
                                if (data.valid) {
                                    location.href = "/";
                                } else {
                                    this.error = true;
                                    this.error_text =
                                        "کد تایید اشتباه است و یا منقضی شده است";
                                    style = "border: 2px solid red";
                                }
                            } else {
                                this.error = true;
                                this.error_text =
                                    "مشکلی پیش آمده، کمی بعد دوباره تلاش کنید";
                            }
                        })
                        .catch((error) => {
                            this.error = true;
                            this.error_text =
                                "مشکلی پیش آمده، کمی بعد دوباره تلاش کنید";
                            style = "border: 2px solid red";
                        });
                }
            },
        },
    });
</script>
{% endraw %} {% endblock %}
