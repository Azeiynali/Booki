{% extends "base.html" %} {% block head %}
<link rel="stylesheet" href="/static/css/home.css" />
<link rel="stylesheet" href="/static/css/post.css" />
<base href="http://127.0.0.1:5000">
{% endblock %} {% block Title %}{{ post.writer.username }} -- {{ content }} {%
endblock %} {% block content %}
<div id="app">
    <navbar></navbar>
    <div class="flex flex-none flex-col items-center gap-10">
        <post {% if post.writer==current_user %} iw="True" {% endif %}
                content="{{ post.content }}" id="{{ post.id }}"
                image="{{ post.img }}"
                username="{{ post.writer.username }}" avatar="{{ post.writer.avatar }}" date="{{ fAge(post.date) }}"
                classes="post img-container min-h-40 rounded-xl mb-5 p-3 bg-[#fefefe]" {% if Like.query.filter_by(liked=post.id, liker=current_user.id).all() %}
                like_classes="liked" {% endif %} likes="{{ Like.query.filter_by(liked=post.id).all() | length }}" comment_length="{{ post.comments | length }}">
            </post>
        <div class="flex flex-none flex-col items-center w-full">
            <div class="flex flex-none justify-center gap-2 items-center flex-row-reverse">
                <div @click="text_ar" class="exam">پست شما بسیار زیبا بود، اما</div>
                <div @click="text_ar" class="exam">بسیار لذت بردم</div>
                <div @click="text_ar" class="exam">این پست بسیار عمیق بود</div>
                <div @click="text_ar" class="exam">این پست می توانست بهتر از این باشد اگر</div>
                <div @click="text_ar" class="exam">اولین کامنت!</div>
            </div>
            <textarea placeholder="به نظر من..." dir="rtl" class="resize-none bg-white rounded-lg w-4/5 p-2 border-solid border-2 border-[#808080] gray-shadow"></textarea>
            <button class="bg-white w-4/5 rounded-lg border-2 border-solid border-[#808080] p-2 mb-2 mt-2 position-all duration-300 send" @click="add_comment">ارسال</button>
            {% for comment in comments %}
                <comment
                    {% if comment.user == current_user %}
                        iw="1"
                    {% else %}
                        iw=""
                    {% endif %}
                    avatar="{{ comment.user.avatar }}"
                    username="{{ comment.user.username }}"
                    id="{{ comment.id }}"
                    content="{{ comment.content }}"
                    date="{{ fAge(comment.date) }}" ></comment>
            {% endfor %}
            <div class="w-full mt-10"></div>
        </div>
    </div>

    {% raw %}
    <script>
        Vue.component("comment", {
            props: ["username", "id", "content", "date", "avatar", "iw"],
            data() {
                return {
                    is: true,
                    delete_button: "حذف",
                };
            },
            methods: {
                delete_() {
                    if (
                        this.$refs.itrash.getAttribute("class") ===
                        "fi fi-rr-check"
                    ) {
                        var myHeaders = new Headers();
                        myHeaders.append(
                            "Content-Type",
                            "application/x-www-form-urlencoded"
                        );

                        var urlencoded = new URLSearchParams();
                        urlencoded.append("id", this.id);
                        var requestOptions = {
                            method: "POST",
                            headers: myHeaders,
                            body: urlencoded,
                            redirect: "follow",
                        };

                        fetch("/api/comment/del", requestOptions)
                            .then((response) => response.text())

                            .then((result) => {
                                this.is = false;
                            })
                            .catch((error) => console.log("error", error));
                    } else {
                        this.$refs.itrash.setAttribute(
                            "class",
                            "fi fi-rr-check"
                        );
                        this.$refs.trash.setAttribute(
                            "class",
                            "mb-3 px-3 gap-10 py-2 rounded flex items-center border-2 border-[#6d6d6d] transition-all duration-300 ease-out hover:opacity-90 bg-white flex-none cursor-pointer justify-center liked"
                        );
                        this.delete_button = "مطمئنید؟";
                    }
                },
            },
            template: `<div v-if="is" class="bg-white w-4/5 flex flex-none justify-start items-center gap-4 relative flex-row-reverse mt-5 rounded-xl">
                        <div dir="rtl" class="p-3 rounded-xl flex flex-none text-center items-center flex-col">
                            <a :href="'\@' + username">
                                <img :src="avatar" class="size-20 rounded-full" />
                            </a>
                            <a :href="'\@' + username">
                                <div>
                                    <p  class="text-black">
                                        {{ username }}

                                    </p>
                                    <small class="text-black">{{ date }}</small>
                                </div>
                            </a>
                        </div>
                        <div dir="rtl" class="content">
                            <p v-html="content"></p>
                        </div>
                        <div v-if="iw" dir="rtl" class="bottom inline-block absolute bottom-1 left-10">
                            <div @click="delete_" ref="trash" class="mb-3 px-3 gap-10 py-2 rounded flex items-center border-2 border-[#6d6d6d] transition-all duration-300 ease-out hover:opacity-90 bg-white flex-none cursor-pointer justify-center">
                                {{ delete_button }} <i ref="itrash" class="fi fi-rr-trash-xmark"></i>
                            </div>
                            </a>
                        </div>
                    </div>`,
        });
        Vue.component("post", {
        props: {
            id: {},
            comment_length: {},
            content: {},
            username: {},
            img: {},
            image: {},
            avatar: {},
            date: "",
            like_classes: {
                default: ""
            },
            likes: {
                default: 0,
            },
            iw: {
                default: false,
            },
            classes: { default: "post" },
        },
        data() {
            return {
                is: true,
                delete_button: "حذف"
            };
        },

        methods: {
            like() {
                // this function to like the post
                // if not liked
                if (this.like_classes) {
                    var data = new FormData();
                    data.append('postId', this.id)
                    fetch('/api/unlike', {
                        method: "POST",
                        body: data,
                    }).then((response) => { return response.json() }).then(
                        (data) => {
                            if (data.success) {
                                this.$refs.like_icon.style.color = "black"
                                this.like_classes = "";
                                this.likes--;
                            }
                        })
                // if liked
                } else {
                    var data = new FormData();
                    data.append('postId', this.id)
                    fetch('/api/like', {
                        method: "POST",
                        body: data,
                    }).then((response) => { return response.json() }).then(
                        (data) => {
                            if (data.success) {
                                this.$refs.like_icon.style.color = "var(--red)"
                                this.like_classes = "liked";
                                this.likes++;
                            }
                        })
                }
            },
            delete_() {
                // this function to delete the post
                if (
                    this.$refs.itrash.getAttribute("class") ===
                    "fi fi-rr-check"
                ) {
                    var myHeaders = new Headers();
                    myHeaders.append(
                        "Content-Type",
                        "application/x-www-form-urlencoded"
                    );

                    var urlencoded = new URLSearchParams();
                    urlencoded.append("id", this.id);
                    var requestOptions = {
                        method: "DELETE",
                        headers: myHeaders,
                        body: urlencoded,
                        redirect: "follow",
                    };

                    fetch("/api/delete", requestOptions)
                        .then((response) => response.text())

                        .then((result) => {
                            this.is = false;
                        })
                        .catch((error) => console.log("error", error));
                } else {
                    this.$refs.itrash.setAttribute(
                        "class",
                        "fi fi-rr-check"
                    );
                    this.$refs.trash.setAttribute("class", "px-3 gap-10 py-2 rounded flex items-center border-2 border-[#6d6d6d] transition-all duration-300 ease-out hover:opacity-90 bg-white flex-none cursor-pointer justify-center liked");
                    this.delete_button = "مطمئنید؟"
                }
            },
        },
        template: `
                        <div v-if="is" :class="classes">
                            <div dir="rtl" class="flex justify-start text-lg w-9/10 text-[#292929] gap-2 relative h-20 user items-center mr-5">
                                <a :href="'\@' + username">
                                    <img :src="avatar" />
                                </a>
                                <a :href="'\@' + username">
                                    <div>
                                        <p>
                                            {{ username }}

                                        </p>
                                        <small>{{ date }}</small>
                                    </div>
                                </a>
                            </div>
                            <div dir="rtl" class="flex gap-3 items-center justofy-center flex-col">
                                <img @dblclick="like" v-if="image != 'http://127.0.0.1:5000/static/pictures/select_post_image.png'" class="img" :src="image" />
                                <p v-html="content"></p>    
                            </div>
                            <div dir="rtl" class="flex flex-none flex-wrap flex-row gap-3 mt-16 border-t-2 border-[#2929292f] pt-3">
                                <div @click="like" ref="like" :class="'px-3 gap-10 py-2 rounded flex items-center justify-between border-2 border-[#6d6d6d] transition-all duration-300 ease-out hover:opacity-90 cursor-pointer  bg-white flex-none ' + like_classes">
                                    <i ref="like_icon" class="fi fi-rr-circle-heart"></i>
                                    <small>{{ likes }}</small>
                                </div>
                                <div v-if="iw" @click="delete_" ref="trash" class="px-3 gap-10 py-2 rounded flex items-center border-2 border-[#6d6d6d] transition-all duration-300 ease-out hover:opacity-90 bg-white flex-none cursor-pointer justify-center">
                                    {{ delete_button }} <i ref="itrash" class="fi fi-rr-trash-xmark"></i>
                                </div>
                                </a>
                            </div>
                        </div>
                    `,
    });
        app = new Vue({
            el: "#app",
            data: {},
            methods :{
                text_ar(ev) {
                    let text = document.querySelector('textarea')
                    text.innerHTML = ev.target.innerText
                },
                add_comment() {
                    let text = document.querySelector('textarea')
                    if (text.value){
                        var myHeaders = new Headers();
                            myHeaders.append(
                                "Content-Type",
                                "application/x-www-form-urlencoded"
                            );

                            var urlencoded = new URLSearchParams();
                            urlencoded.append("content", text.value);
                            // {% endraw %}
                            urlencoded.append("id", "{{ post.id }}");
                            // {% raw %}
                            var requestOptions = {
                                method: "POST",
                                headers: myHeaders,
                                body: urlencoded,
                                redirect: "follow",
                            };

                            fetch("/api/comment/add", requestOptions)
                                .then((response) => response.text())
                                .then((result) => {
                                    location.reload()
                                })
                                .catch((error) => console.log("error", error));
                    }
                },
            }
        });
    </script>
    {% endraw %} {% endblock %}
</div>
